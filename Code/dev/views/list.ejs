<!doctype html>
<html>
  <head>
    <%- include ("partials/head.ejs") -%>
    
  </head>

  <body>
    <div class="container-fluid">
      <div class="col-md-12 py-5 px-3 mx-auto">
        <%- include ("partials/nav.ejs") -%>
  
        <div class ="row">
          <div class="col-lg-2 px-0">
            <% if (user) { %>
            <a href ="/addcode">Add new code</a>
            <% } %>
          </div>
        <div class="col-lg-8 px-0">
          
          <h2 class="text-align-center"><%= title %><% if(subtitle){ %>: <%=unescape(subtitle)%><% } %></h2>
          <p class="lead">All code snippets</p>
          Tags:
          <%  tags.forEach(function(item){ %> 
            <label><%=item%></label>
          <% }) %>
          
          <table class="table">
            <thead>
              <tr>
                <th scope="col">Votes</th>
                <th scope="col">Code</th>
                <th scope="col">Contributed By</th>
                <th scope="col">Description</th>
                <th scope="col"></th>
                <th scope="col"></th>
              </tr>
            </thead>
            <tbody>
              <%  dbresults.forEach(function(item){ %> 
              <tr><th scope="row"><%=item[7] %></th>
              <td><%=item[3] %></td>
              <td><%=item[0] %></td>
              <td><%=item[4] %></td>
              <td><a href="/viewcode?type=<%= unescape(title).toLowerCase() %>&id=<%= item[8]%>" class="btn btn-primary" ></button>View</a></td>
              <% if (user) { %>
                <% if (item[9]==null) { %>
                  <td><a ><button class="btn btn-dark" id="btn-voted-<%= item[8]%>" onclick="VoteBtnOnClick(this)">Vote</button></a></td>
                <% }else{ %>
                  <td><a ><button class="btn btn-dark" id="btn-voted-<%= item[8]%>" onclick="VoteBtnOnClick(this)"  disabled>Voted</button></a></td>
                <% } %>
              <% } %>
              </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>
  
  
  
        <%- include ("partials/footer.ejs") -%>
      </div>
    </div>
    <script>
      function VoteBtnOnClick(obj){
        let btn_id = obj.id;
        let post_id = btn_id.slice(10);
        let post_type = `<%= title.toLowerCase()%>`;
        console.log(post_type);
        $.ajax({
          type: 'post',
          url: '/voted',
          data: {id: post_id, type: post_type},
          success: function(results){
            let html = 'Voted'
            let btn_id = '#' + obj.id;

            if(results == 'success'){
              $(btn_id).html(html);
              $(btn_id).attr('disabled',true);
            }
          }
        })
      }
    </script>

  </body>

</html>
